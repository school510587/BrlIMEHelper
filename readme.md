# Braille IME Helper
Version 2.1

## Introduction
Braille IME Helper (BrlIMEHelper) enables users to input Chinese characters directly through the braille keyboard on a braille display. When no braille keyboard is available, the addon can also simulate it using a computer keyboard. With conversion from braille input to IME operations by the addon, users familiar to braille rules can input Chinese characters without learning other input methods and keyboard layouts. So far, the addon is an implementation based on [bopomofo braille](https://en.wikipedia.org/wiki/Taiwanese_Braille) and 微軟注音 IME commonly used in Taiwan, but its concept can be extended to other braille systems and IMEs in the future.

## Features
1. Chinese input (including punctuations and math symbols) through the braille keyboard.
2. Simulating braille keyboard by a computer keyboard.
3. Allowing system and NVDA keyboard shortcuts.
4. Different braille composition modes for different windows.
5. Allowing password input on a web browser by the braille keyboard.
6. Various customization options from users' feedback.

## System and environment requirements
Before installation, check the following environment settings:

- NVDA 2017.3 or later.
- 微軟注音 must be your default IME with the following configuration:
    * The composition mode must be default to alphanumeric.
    * Use standard bopomofo keyboard layout. (default)
    * The function of the left Shift must be to toggle the composition mode. (default)
- If you would like to simulate braille keyboard by a computer keyboard, check that it supports NKRO (N-key rollover). See also: [What PC keyboards allow for 6-key braille data entry?](https://www.duxburysystems.com/faq2.asp?faq=32&fbclid=IwAR0zdRHClvT5gikN_RqAEX_phxEp51HZX9dtDGUkWU5gTprmvBUPyBs5cFk)
- Please prevent Braille IME Helper from running with other applications or addons related to braille input, such as [PC Keyboard Braille Input for NVDA](https://addons.nvda-project.org/addons/pcKeyboardBrailleInput.en.html) addon and [Braille Chewing](https://github.com/EasyIME/PIME "PIME").
- It is suggested to disable "Report changes to the reading string" option of NVDA's input composition settings to enjoy better experience during quick typing.
- It is suggested to set the braille input table to "English (U.S.) 8 dot computer braille", so that NVDA's behavior is closer to the habit of Taiwanese users.

## Manipulation

### Gestures

#### Braille Keyboard

* Dots 4, 5, 6 + Space: Toggle between alphanumeric and native modes. The effect is the same as pressing Shift on a computer keyboard.
* Dot 1 + Space: Review the braille buffer, i.e., what you just enter in native mode before finish of composition. (Example: 135 126 is insufficient for composition, but this function shows that you have entered ㄅㄛ.)
* Dots 2, 4, 5 + Space: Clear braille buffer on typo to re-enter the correct content.
* Dots 1, 2, 3 + Space: Enable/Disable braille input simulation in IME alphanumeric mode.

#### Computer Keyboard

* NVDA+Ctrl+6: Enable/Disable the feature of simulating braille keyboard by a computer keyboard.
* F, D, S, J, K, L, A, semicolon `[;:]`, and space bar: Dot 1 through 8 and braille space.
* 0 through 9: Reserved for number input and candidate word selection.
* NumPad (optional feature, with Num Lock on): Input of a braille cell dot by dot.
    + 0 through 8: The braille space and dots 1 through 8.
    + 9: Clear uncompleted braille cell.
    + Decimal point `[.]`: Complete input of one braille cell.
    + Divide `[/]`: View uncommitted braille cell.

#### Braille Keyboard Emulated by Computer Keyboard

With this addon, the user can send braille input through braille keys on a computer keyboard as if it were a physical braille keyboard. Dummy braille input generated by this addon has two sources, "No braille" and the current working braille display. The same gesture (usually dots with space) may be assigned to two different operations by them, but the user can decide their behavior through configuration.

The addon provides over 150 gestures to emulate various key shortcuts by dummy braille input, in order to reduce hand moving of the user. They are categorized into 3 classes, and the original proposal of design in Chinese is available in [message #3664 of nvda-tw group](https://groups.io/g/nvda-tw/message/3664).

Throughout the section, gestures consist of simultaneously pressed braille dot key(s) and the braille space. For simplicity, only braille dots are mentioned. Tables listing these key shortcuts and their correiponding functions are below. If function of a key shortcut is represented by key names (e.g. `[Ctrl]+[A]`), then the specified key sequence is sent to the system. Otherwise, the specified NVDA or addon feature is executed.

Compatibility warning: NVDA versions earlier than 2018.3 disallow braille input from "No braille", so source of gestures provided by the addon is "braille keyboard". If the running braille display driver does not define the same gesture, then braille input generated by its physical braille keyboard may cause execution of them, which does not happen in newer NVDA versions.

##### Class One

Gestures in this class must include dot 1 and/or dot 4. The design principles are as follows:

1. Gestures consisting of dot 1 to dot 6 may represent a key (or shortcut) on a computer keyboard or an operation in NVDA. Most gestures of this type are not occupied to preserve flexibility of user customization.
2. Gestures with dot 7 and/or dot 8 represent key shortcuts with `[Ctrl]` and/or `[Alt]`.

<table border="1">
 <tr><th>Dots (+ space)</th><th>Function</th><th>+ dot 7</th><th>+ dot 8</th><th>+ dots 7, 8</th></tr>
 <tr><td>1</td><td>Occupied by BrlIMEHelper</td><td>[Ctrl]+[A]</td><td>[Alt]+[A]</td><td>[Ctrl]+[Alt]+[A]</td></tr>
 <tr><td>12</td><td>None</td><td>[Ctrl]+[B]</td><td>[Alt]+[B]</td><td>[Ctrl]+[Alt]+[B]</td></tr>
 <tr><td>14</td><td>[Ctrl]</td><td>[Ctrl]+[C]</td><td>[Alt]+[C]</td><td>[Ctrl]+[Alt]+[C]</td></tr>
 <tr><td>145</td><td>None</td><td>[Ctrl]+[D]</td><td>[Alt]+[D]</td><td>[Ctrl]+[Alt]+[D]</td></tr>
 <tr><td>15</td><td>None</td><td>[Ctrl]+[E]</td><td>[Alt]+[E]</td><td>[Ctrl]+[Alt]+[E]</td></tr>
 <tr><td>124</td><td>None</td><td>[Ctrl]+[F]</td><td>[Alt]+[F]</td><td>[Ctrl]+[Alt]+[F]</td></tr>
 <tr><td>1245</td><td>None</td><td>[Ctrl]+[G]</td><td>[Alt]+[G]</td><td>None</td></tr>
 <tr><td>125</td><td>None</td><td>[Ctrl]+[H]</td><td>[Alt]+[H]</td><td>[Ctrl]+[Alt]+[H]</td></tr>
 <tr><td>24</td><td>None</td><td>[Ctrl]+[I]</td><td>[Alt]+[I]</td><td>[Ctrl]+[Alt]+[I]</td></tr>
 <tr><td>245</td><td>Occupied by BrlIMEHelper</td><td>[Ctrl]+[J]</td><td>[Alt]+[J]</td><td>[Ctrl]+[Alt]+[J]</td></tr>
 <tr><td>13</td><td>None</td><td>[Ctrl]+[K]</td><td>[Alt]+[K]</td><td>[Ctrl]+[Alt]+[K]</td></tr>
 <tr><td>123</td><td>Occupied by BrlIMEHelper</td><td>[Ctrl]+[L]</td><td>[Alt]+[L]</td><td>[Ctrl]+[Alt]+[L]</td></tr>
 <tr><td>134</td><td>[Alt]</td><td>[Ctrl]+[M]</td><td>[Alt]+[M]</td><td>[Ctrl]+[Alt]+[M]</td></tr>
 <tr><td>1345</td><td>Show the NVDA menu</td><td>[Ctrl]+[N]</td><td>[Alt]+[N]</td><td>None</td></tr>
 <tr><td>135</td><td>None</td><td>[Ctrl]+[O]</td><td>[Alt]+[O]</td><td>[Ctrl]+[Alt]+[O]</td></tr>
 <tr><td>1234</td><td>None</td><td>[Ctrl]+[P]</td><td>[Alt]+[P]</td><td>None</td></tr>
 <tr><td>1235</td><td>None</td><td>[Ctrl]+[R]</td><td>[Alt]+[R]</td><td>None</td></tr>
 <tr><td>234</td><td>[Shift]</td><td>[Ctrl]+[S]</td><td>[Alt]+[S]</td><td>[Ctrl]+[Alt]+[S]</td></tr>
 <tr><td>2345</td><td>None</td><td>[Ctrl]+[T]</td><td>[Alt]+[T]</td><td>None</td></tr>
 <tr><td>136</td><td>None</td><td>[Ctrl]+[U]</td><td>[Alt]+[U]</td><td>[Ctrl]+[Alt]+[U]</td></tr>
 <tr><td>1236</td><td>None</td><td>[Ctrl]+[V]</td><td>[Alt]+[V]</td><td>None</td></tr>
 <tr><td>2456</td><td>[Win]</td><td>[Ctrl]+[W]</td><td>[Alt]+[W]</td><td>None</td></tr>
 <tr><td>1346</td><td>[Alt]+[F4]</td><td>[Ctrl]+[X]</td><td>[Alt]+[X]</td><td>None</td></tr>
 <tr><td>1356</td><td>None</td><td>[Ctrl]+[Z]</td><td>[Alt]+[Z]</td><td>None</td></tr>
 <tr><td>246</td><td>[PgUp]</td><td>[Ctrl]+[PgUp]</td><td>[Alt]+[PgUp]</td><td>None</td></tr>
 <tr><td>1256</td><td>[PgDn]</td><td>[Ctrl]+[PgDn]</td><td>[Alt]+[PgDn]</td><td>None</td></tr>
 <tr><td>12456</td><td>Say all from the system caret</td><td>None</td><td>None</td><td>None</td></tr>
 <tr><td>45</td><td>[Home]</td><td>[Ctrl]+[Home]</td><td>[Alt]+[Home]</td><td>None</td></tr>
 <tr><td>2346</td><td>[Esc]</td><td>[Ctrl]+[Esc]</td><td>[Alt]+[Esc]</td><td>None</td></tr>
 <tr><td>3456</td><td>[Delete]</td><td>[Ctrl]+[Delete]</td><td>[Alt]+[Delete]</td><td>None</td></tr>
 <tr><td>1246</td><td>[End]</td><td>[Ctrl]+[End]</td><td>[Alt]+[End]</td><td>None</td></tr>
 <tr><td>146</td><td>[&darr;]</td><td>[Ctrl]+[&darr;]</td><td>[Alt]+[&darr;]</td><td>[Ctrl]+[Alt]+[&darr;]</td></tr>
 <tr><td>12346</td><td>[App]</td><td>None</td><td>None</td><td>None</td></tr>
 <tr><td>12356</td><td>[NVDA]+[F9]</td><td>None</td><td>None</td><td>None</td></tr>
 <tr><td>23456</td><td>[NVDA]+[F10]</td><td>None</td><td>None</td><td>None</td></tr>
 <tr><td>16</td><td>[Shift]+[Tab]</td><td>[Ctrl]+[Shift]+[Tab]</td><td>[Alt]+[Shift]+[Tab]</td><td>None</td></tr>
 <tr><td>346</td><td>[&uarr;]</td><td>[Ctrl]+[&uarr;]</td><td>[Alt]+[&uarr;]</td><td>[Ctrl]+[Alt]+[&uarr;]</td></tr>
 <tr><td>34</td><td>[Tab]</td><td>[Ctrl]+[Tab]</td><td>[Alt]+[Tab]</td><td>None</td></tr>
 <tr><td>126</td><td>[&larr;]</td><td>[Ctrl]+[&larr;]</td><td>[Alt]+[&larr;]</td><td>[Ctrl]+[Alt]+[&larr;]</td></tr>
 <tr><td>345</td><td>[&rarr;]</td><td>[Ctrl]+[&rarr;]</td><td>[Alt]+[&rarr;]</td><td>[Ctrl]+[Alt]+[&rarr;]</td></tr>
</table>

##### Class Two

There are 15 combinations generated by dots 2, 3, 5, and 6 in this class. The following subclasses are determined by the emulated functions.

1. Numpad number keys: `[1]` through `[9]` are represented by 9 braille digits consisting of dots 2, 3, 5, and 6.
2. Numpad `[/]`, `[+]`, `[.]`, `[-]`, and `[*]`: Represented respectively by dot(s) 5, 56, 3, 36, and 6.
3. Numpad keys with NVDA key: Dot 8 along with all gestures of the previous two subclasses.
4. `[F1]` through `[F12]`: Dot 7 along with 9 gestures of the first subclass and the first 2 gestures of the second subclass. `[F10]` is represented by dots 3567.
5. Windows key shortcuts: Dots 7 and 8 along with some gestures of the first 2 subclasses to emulate some system key shortcuts such as `[Win]+[D]` and `[Win]+[T]`. Note that dots 3678 emulate opening the control panel.
6. Numpad `[Enter]` with the NVDA key: Dots 3568.

<table border="1">
 <tr><th>Dots (+ space)</th><th>Function</th><th>+ dot 7</th><th>+ dot 8</th><th>+ dots 7, 8</th></tr>
 <tr><td>2</td>
  <td>Move the review cursor to the previous character of the current navigator object and speak it</td>
  <td>[F1]</td>
  <td>Switch to the previous review mode</td>
  <td>[Win]+[A]</td>
 </tr>
 <tr><td>23</td>
  <td>Report the character of the current navigator object where the review cursor is situated</td>
  <td>[F2]</td>
  <td>Move the navigator object to the first object inside it</td>
  <td>[Win]+[B]</td>
 </tr>
 <tr><td>25</td>
  <td>Move the review cursor to the next character of the current navigator object and speak it</td>
  <td>[F3]</td>
  <td>None</td>
  <td>[Win]+[X]</td>
 </tr>
 <tr><td>256</td>
  <td>Move the review cursor to the previous word of the current navigator object and speak it</td>
  <td>[F4]</td>
  <td>Move the navigator object to the previous object</td>
  <td>[Win]+[D]</td>
 </tr>
 <tr><td>26</td>
  <td>Speak the word of the current navigator object where the review cursor is situated</td>
  <td>[F5]</td>
  <td>Report the current navigator object</td>
  <td>None</td>
 </tr>
 <tr><td>235</td>
  <td>Move the review cursor to the next word of the current navigator object and speak it</td>
  <td>[F6]</td>
  <td>Move the navigator object to the next object</td>
  <td>None</td>
 </tr>
 <tr><td>2356</td>
  <td>Move the review cursor to the previous line of the current navigator object and speak it</td>
  <td>[F7]</td>
  <td>Switch to the next review mode</td>
  <td>None</td>
 </tr>
 <tr><td>236</td>
  <td>Report the line of the current navigator object where the review cursor is situated</td>
  <td>[F8]</td>
  <td>Move the navigator object to the object containing it</td>
  <td>None</td>
 </tr>
 <tr><td>35</td>
  <td>Move the review cursor to the next line of the current navigator object and speak it</td>
  <td>[F9]</td>
  <td>None</td>
  <td>[Win]+[I]</td>
 </tr>
 <tr><td>356</td>
  <td>None</td>
  <td>[F10]</td>
  <td>Perform the default action on the current navigator object</td>
  <td>None</td>
 </tr>
 <tr><td>5</td>
  <td>Click the left mouse button once at the current mouse position</td>
  <td>[F11]</td>
  <td>Move the mouse pointer to the current navigator object</td>
  <td>None</td>
 </tr>
 <tr><td>56</td>
  <td>Read from the review cursor up to the end of the current text, moving the review cursor as it goes</td>
  <td>[F12]</td>
  <td>None</td>
  <td>None</td>
 </tr>
 <tr><td>3</td>
  <td>None</td>
  <td>None</td>
  <td>Report information about the location of the text or object at the review cursor</td>
  <td>[Win]+[Tab]</td>
 </tr>
 <tr><td>36</td>
  <td>None</td>
  <td>None</td>
  <td>Set the navigator object to the current focus, and the review cursor to the position of the caret inside it, if possible</td>
  <td>Open the control panel</td>
 </tr>
 <tr><td>6</td>
  <td>Click the right mouse button once at the current mouse position</td>
  <td>None</td>
  <td>Set the navigator object to the current object under the mouse pointer and speak it</td>
  <td>[Win]+[T]</td>
 </tr>
</table>

##### Class Three

There are 3 gestures in this class, consisting of dot 7, dot 8, and space.

* Dot 7 + Braille space: `[Win]+[Space]`
* Dots 7, 8 + Braille space: `[Win]+[Shift]+[Space]`
* Dot 8 + Braille space: `[Alt]+[Space]`

### Options

#### Automatically enable braille keyboard simulation when NVDA starts
If checked, braille keyboard simulation is enabled automatically when NVDA starts.

#### The key shortcut to toggle IME alphanumeric/native mode

It determines the key command sent by the addon when the user presses dots 4, 5, and 6 along with the braille space. To keep the behavior consistent, the default is left shift.

Note: Windows XP users, please configure the default language mode of 新注音 to native mode if you would like to use `[Ctrl]+[Space]` to switch between 美式鍵盤 and 新注音.

#### Disable braille keyboard simulation by default in IME alphanumeric mode
If checked, the user can always type characters by the current keyboard layout in IME alphanumeric mode. The option improves experience of users who are familiar to the standard computer keyboard but new to IME keyboard layout of its native mode.

#### "Braille Keys" and "Ignored Keys"
Users can determine positions of braille dots, braille space, and ignored (reserved) keys for braille keyboard simulation in BrlIMEHelper settings dialog. Braille keyboard simulation is automatically disabled when either of the "Braille Keys" or the "Ignored Keys" edit control is focused. Exact 9 braille keys are required, but number of ignored keys is unlimited. If a key appears in both options, "Braille Keys" takes precedence. After entering all key positions by single computer keyboard strokes, `[Apply]` or `[OK]` button press is necessary to take effect. Occasionally, the "Braille Keys" option may not fully work, because simultaneous transmission of some key commands is unsupported by internal design of your computer (or notebook) keyboard. Please change your configuration to find a set of feasible braille keys.

#### Free all non-braille keys during braille keyboard simulation in IME alphanumeric mode
If checked, all keys, except the braille keys, are ignored during braille keyboard simulation in IME alphanumeric mode.

#### Keyboard Mapping
The option corresponds to the configuration of keyboard layout in IME native mode.

#### Allow dot-by-dot braille input via numpad during braille keyboard simulation
If checked, the user can input braille cells dot by dot via the numpad with Num Lock on.

#### Indication of manual/automatic toggle of braille keyboard simulation
The two options determines indication of toggle of braille keyboard simulation. Particularly, automatic toggling may occur after change of foreground window and/or options of the addon.

#### Consistent braille keyboard simulation toggle state for all processes
If checked, there is only one single state of braille keyboard simulation toggle, which is the behavior of all versions earlier than 2.0. Otherwise, the addon logs state of each process independently. A user who allows different IMEs for different windows may uncheck this option to reduce times of toggling braille keyboard simulation. Note that all toggle states of processes become the default state of NVDA starting if this option is changed from unchecked to checked.

### Remarks
1. In alphanumeric mode, the effect is determined by NVDA's braille input table.
2. The original NVDA behavior of dot 7, dot 8, and dot 7 + dot 8 is preserved in both modes.
3. The addon do not influence other buttons on a braille display, such as buttons for scrolling and positioning.
4. Users may manage all above shortcuts via NVDA input gestures dialog and BrlIMEHelper settings dialog.
5. If no composed character is spoken after composition completion, then IME may get stuck by unreasonable (phonetic) input.

## Issues and ways of development
- Known bugs:
    * When "Show messages indefinitely" option is enabled, the message does not disappear as the content of composition changes.
    * NVDA braille does not reflect immediately as user input in "Braille Keys" and "Ignored Keys" edit controls.
- Possible improvements in the future:
    * Allow users to customize the default state of the addon.
    * Allow users to customize dot patterns of symbols, and/or to load dot patterns from braille translation tables.
    * Allow the addon to work with other IMEs.

## Contributors
- Bo-Cheng Jhan &lt;<school510587@yahoo.com.tw>&gt;
- 黃偉豪 &lt;<hurt.nzsmr@gmail.com>&gt;

## Acknowledgement
- BrlIMEHelper has been sponsored by [Taiwan Visually Impaired People Association](https://www.twvip.org) &lt;<vipastaiwan@gmail.com>&gt; from 2019/07/01 to 2020/06/30, hereby express our sincere appreciation.

## History of changes

### Version 0.0
* The initial version.

### Version 0.1
* Refactor the documentation, so that it becomes more readable by users.
* Reset the braille buffer when the foreground window changes.

### Version 0.2
* Fixed the wrong behavior of simulation of dot 7 (A) in explorer.
* Split __init__.py into two files.

### Version 0.3
* Enable localization of messages.
* Implement new braille parsing scheme.
* Add "addon_lastTestedNVDAVersion" information.
* Add rules to ensure input of a single bopomofo symbol.
* Correct several input dot patterns of math symbols.

### Version 0.4
* Implement compatibility of braille pattern prefixes by delayed input sending.
* Try to substitute the most recent braille input on braille input rejection.
* Change the braille pattern of ∠ into ⠫⠪ (1246-246), i.e. the prefix of ←.

### Version 0.5
* Code refactoring.
* Stop simulating braille keyboard by a computer keyboard in browse mode.
* Assign proper documentation and category to each script.

### Version 0.6
* Implement a toggle to enable/disable braille input simulation in IME alphanumeric mode.
* Handle bopomofo.json path in str type.
* Do not simulate braille input if some modifier key is still held down on loading BrlIMEHelper keyboard hooks.

### Version 0.7
* Add dot pattern variants of some symbols.
* Let braille shortcuts be manageable by NVDA input gesture manager.
* Adjust some coding style of command scripts.

### Version 1.0
* Support NVDA 2019.3 based on Python 3.
* Implement a dialog for user configurations.

### Version 1.1
* Use a more proper sound effect for the warning of typo.
* Allow users to customize positions of braille keys and ignored keys on a computer keyboard.
* Add an `[Apply]` button into the settings dialog.

### Version 1.2
* Allow users to ignore all non-braille keys during braille keyboard simulation in alphanumeric mode.
* Add "Keyboard Mapping" option corresponding to the keyboard mapping option of 微軟注音 IME.
* Allow braille input of rhymes with ⡼ prefix.

### Version 2.0
* Allow dot-by-dot braille input via numpad keys.
* Add feedback manners of audio and none for indication of braille keyboard simulation toggle.
* Allow independent state of braille keyboard simulation toggle for each process.
* Modify keyboard shortcut NVDA+X to NVDA+Ctrl+6.
* Add specification for all options into readme.md.
* Code refactoring.
